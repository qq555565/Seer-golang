# 技能效果实现状态说明

本文档说明 `data/skills.xml` 中 SideEffect ID（对应 1000001~1000xxx）在 Go 服务端的实现情况。

## 实现方式

- **ApplyEffect**（`internal/game/skills/effects.go`）：单次状态修改（回血、加减能力、挂异常等）。
- **Handlers**（`internal/handlers/handlers.go`）：回合状态（多回合 BUFF、必中、减伤、击败回血等）、伤害/先制公式。
- **BattleState**（`internal/server/gameserver/gameserver.go`）：多回合效果所需字段。

## 已完整实现的效果（按 ID）

| ID | 说明 | 位置 |
|----|------|------|
| 1 | 吸血（伤害比例回血） | ApplyEffect |
| 2 | 降低对方能力等级 | ApplyEffect |
| 3 | 解除能力下降 / 提高自身能力（有参） | ApplyEffect |
| 4,5 | 提升/降低能力（多组 stat chance stages） | ApplyEffect |
| 6 | 反伤 1/n | ApplyEffect |
| 7 | 同生共死 | ApplyEffect |
| 8 | 手下留情（留 1 血） | Handlers 伤害上限 |
| 9 | 愤怒（伤害范围内攻击+1） | ApplyEffect |
| 10,11,12,13,14,15,16 | 麻痹/中毒/烧伤/冻伤/害怕/睡眠 | ApplyEffect |
| 20,21,22 | 疲惫、反弹、令对手疲惫 | ApplyEffect |
| 28,29 | 按比例/固定扣体、固定伤害 | ApplyEffect |
| 30 | 后手威力 2 倍 / 概率麻痹 | Handlers+ApplyEffect |
| 31 | 多段攻击 | Handlers 命中次数 |
| 32 | n 回合暴击率增加 1/16 | Handlers 主 switch + 多效果 + 敌方对称，回合末递减 |
| 33 | 消除对手能力提升 | ApplyEffect |
| 34,35,36 | 克制/惩罚/秒杀 | Handlers 伤害 |
| 37 | 降对方能力 / 低血威力倍 | ApplyEffect+Handlers |
| 38 | 固定扣体 | ApplyEffect |
| 39 | 降对手 PP | Handlers |
| 40 | 先手威力 2 倍 | Handlers |
| 41~50 | 火抗/电伤×2/特防减半/防御同对手/挡n次/免疫能力下降/免疫异常/护盾/物防减半 | Handlers 回合状态 |
| 43 | 恢复最大体力 1/n | ApplyEffect |
| 51~56 | 攻击同对手/先手miss/伤害倍/对方伤害1/m/属性反转/属性相同 | Handlers |
| 57 | 每回合回血 1/m（当回合先回一次） | ApplyEffect + Handlers 回合 |
| 58 | 下 n 回合必暴击 | Handlers |
| 59 | 牺牲强化下一只 | Handlers |
| 60 | 多回合固定伤害 | Handlers |
| 76 | m% 几率 n 回合每回合 k 点固定伤害 | Handlers |
| 77 | n 回合内每次使用技能恢复 m 点体力 | Handlers |
| 78 | n 回合内物理攻击对自身必定 miss | Handlers |
| 82 | 目标为雄性伤害 200%、雌性 50% | Handlers 伤害计算 |
| 83 | 自身雄性下两回合必定先手；雌性下两回合必定暴击 | Handlers |
| 84 | n 回合内受到物理攻击时 m% 几率将对手麻痹 | Handlers |
| 86 | n 回合内属性（特殊）攻击对自身必定 miss | Handlers |
| 89 | n 回合内造成伤害时吸血 damage/divisor | Handlers |
| 90 | n 回合己方攻击伤害 m 倍（同 53） | Handlers |
| 91 | n 回合内双方状态变化同时影响己方与对手（能力/异常镜像） | Handlers 回合状态 + ApplyEffect 后镜像双方 battleLv/status 变化并递减 |
| 92 | n 回合内受到物理攻击时 m% 几率将对手冻伤 | Handlers |
| 98 | n 回合内对雄性精灵的伤害为 m 倍 | Handlers 伤害计算 |
| 103 | n% 几率令对手随机能力-1（衰弱） | ApplyEffect |
| 104 | n 回合内每次直接攻击 m% 几率附带衰弱 | Handlers |
| 106 | n 回合内属性攻击对自身必定 miss（同 86） | Handlers |
| 107 | 若本次攻击造成的伤害小于 n 则自身 xx 等级+1 | Handlers 伤害后判定 |
| 108 | n 回合内受到物理攻击时 m% 几率将对手烧伤 | Handlers |
| 112 | 固定 250~300 伤害，致命时留 1 血 | ApplyEffect |
| 114 | n% 概率使对方烧伤 | ApplyEffect |
| 115 | 造成伤害时 n% 对方减血 1/m | Handlers 伤害后 + ApplyEffect |
| 116 | n 回合内受击造成伤害的 1/5 恢复自身体力 | Handlers 回合状态 + 受击回血 + 敌方对称 + 递减 |
| 117 | n 回合内受击 m% 概率使对手疲惫 | Handlers 回合状态 + 受击判定 + 敌方对称 + 递减 |
| 109 | n 回合内造成伤害时 m% 几率令对手冻伤 | Handlers |
| 95 | 对手处于睡眠状态时致命一击率提升 n/16 | Handlers 暴击判定 |
| 96 | 对手处于烧伤状态时威力翻倍 | Handlers 伤害计算 |
| 97 | 对手处于冻伤状态时威力翻倍 | Handlers 伤害计算 |
| 100 | 自身体力越少则威力越大 | Handlers 伤害计算 |
| 102 | 对手处于麻痹状态时威力翻倍 | Handlers 伤害计算 |
| 61 | 威力随机（0~等级×n 或类似） | Handlers 伤害计算 |
| 62 | 镇魂歌 | Handlers |
| 63 | 能力下降反馈对手 | ApplyEffect |
| 70 | 威力 0 时按固定公式计算 | Handlers 伤害计算 |
| 88 | n% 几率伤害 m 倍 | Handlers 伤害计算（命中后掷骰乘倍） |
| 65 | 某属性威力倍 | Handlers |
| 66 | 击败回血 1/n | Handlers（玩家击杀时） |
| 67 | 击败减对方下只最大 HP 1/n | Handlers（玩家击杀时） |
| 68 | 致死留 1 血 | Handlers |
| 69 | 药剂反噬 | Handlers |
| 71,72,73 | 牺牲暴击/Miss 死亡/先手反弹 | Handlers |
| 74,75 | 三态异常随机一种 | ApplyEffect |
| 79,80 | 半血强化/半血等伤 | ApplyEffect |
| 81 | 下 n 回合必中 | Handlers |
| 85 | 对手能力提升转化己方 | ApplyEffect |
| 87 | 恢复自身所有 PP | Handlers 多效果循环 |
| 93,94,99 | 附加固定伤/石化/混乱 | ApplyEffect |
| 101,105 | 伤害比例回血/损伤 1/n 回血 | ApplyEffect |
| 119 | 奇数伤害→30%令对手疲惫；偶数→30%自身速度+1 | ApplyEffect |
| 120 | 50% 对方减血 1/n，50% 自己减血 1/n | ApplyEffect |
| 124 | n% 概率使对方随机能力降低 m 级 | ApplyEffect |
| 137 | 半血攻速+2 | ApplyEffect |
| 143 | 对手能力提升反转成下降 | ApplyEffect |
| 147 | 后出手时 n% 令对方 XX（handlers 先后手过滤） | ApplyEffect |
| 148 | 后出手时 m% 对方 XX 等级降 n（handlers 先后手过滤） | ApplyEffect |
| 158 | 击败对手时 m% 自身 XX 等级 +n（handlers 击败过滤） | ApplyEffect |
| 172 | 后出手时伤害 1/n 回血（handlers 先后手过滤） | ApplyEffect |
| 173 | 先出手时 n% 令对方 XX（handlers 先后手过滤） | ApplyEffect |
| 186 | 后出手时 m% 自身 XX 等级 +n（handlers 先后手过滤） | ApplyEffect |
| 188 | 对手异常时威力翻倍（Handlers 伤害阶段）并消除对手防/特防强化（ApplyEffect） | ApplyEffect + Handlers |
| 123 | n 回合内受到任何伤害时自身 XX 提高 m 级 | Handlers 回合状态 + 受击时加能力 |
| 125 | n 回合内被攻击时伤害上限 m | Handlers 回合状态 + 受击时封顶 |
| 126 | n 回合内每回合自身攻击和速度 +m 级 | Handlers 回合末加攻速并递减 |
| 128 | n 回合内所受物理伤害转化为体力恢复 | Handlers 回合状态 + 受击时转回血 |
| 127 | n% 概率 m 回合内受到伤害减半 | Handlers 使用技能时掷骰设状态 + 受击时减半 + 回合末递减 |
| 144 | 消耗自己所有体力，使下一只出战的精灵 n 回合免疫异常 | ApplyEffect 扣至 0 血 + Handlers 设 SacrificeImmune 状态 + 换下一只时赋免疫回合 |
| 146 | n 回合内受物理攻击时 m% 使对方中毒 | Handlers 回合状态 + 受击时掷骰挂中毒 + 回合末递减 |
| 149 | 命中后 n% 令对方 xx、m% 令对方 XX（双异常独立判定） | ApplyEffect 两对 (chance, statusIdx) 独立判定挂状态 |
| 150 | n 回合内对手每回合防、特防等级 m | Handlers 回合状态 + 回合末设对手防/特防等级并递减 |
| 185 | 击败处于 XX 状态的对手则下一只出场也进入 XX 状态 | Handlers 击败记录 + 切换下一只时挂状态 |
| 195 | 无视对手双防能力提升（清零对手防御/特防强化） | ApplyEffect |
| 201 | 组队时恢复己方 1/n 体力 | ApplyEffect |
| 402 | 后出手时附加 n 点固定伤害（handlers 先后手过滤） | ApplyEffect |
| 405 | 先出手时附加 n 点固定伤害（handlers 先后手过滤） | ApplyEffect |
| 428 | 遇天敌时附加 m 点固定伤害（仅 typeMod>1 时在 Handlers 中附加） | Handlers |
| 429 | 固定伤递增（base + 每次 increment，最高 max） | ApplyEffect 基础 + Handlers 递增与伤害 |
| 438 | n% 几率恢复 1/m 体力 | ApplyEffect |
| 439 | 自身弱化或异常时对手每回合固伤 | Handlers 回合 |
| 448 | 每回合对手全能力降低 | Handlers 回合 |
| 478 | 对手属性技能无效 | Handlers |
| 508 | 下回合受伤减少 m 点 | Handlers |
| 471 | 先出手时 n 回合内免疫异常 | Handlers 主 switch + 敌方对称 |
| 484 | 攻击 n 次内每次伤害加成（times bonus cap） | Handlers 伤害后判定 |
| 490 | 造成伤害超过 m 则自身速度 +n 级 | Handlers 伤害后判定 |
| 545 | 受到伤害高于 m 则对手获得效果 | Handlers |
| 687 | 对手异常时伤害比例回血 | ApplyEffect |
| 1635 | 誓言之约（立即回+延迟满血） | ApplyEffect + Handlers |

## 占位与说明

- **已实现但未逐条列入上表**：21（反弹）、39（降 PP）、40（先手 2 倍）、51~56（回合状态）、118（威力随机）、122（先手降能力）、129/130/131（性别威力/附加/免疫）、134（伤害低于阈值 PP+）、135（伤害下限）、136（Miss 回血）、179（属性相同威力）、193（对手某状态必暴）、454/482/488（先制/伤害条件）等均在 Handlers 或 ApplyEffect 中有对应逻辑。
- **61/70/88**：威力随机或固定公式（61/70）、n% 几率伤害 m 倍（88）在伤害计算/命中后处理。
- **31/35/36**：多段、惩罚、秒杀在 Handlers 中处理。
- **BOSS/特殊多效果**：691、700、773、935、976、1083、1211、1248、1257、1470、1603、1605、1850、1925、2236、2237 已在下表完整列出；`effectArgCount` 已按 XML 多效果参数对齐，Handlers 多效果循环中已为上述 ID 预留 case（当前仅消费参数、不修改战斗状态），ApplyEffect 中为占位 case，后续可按配置扩展具体战斗逻辑。

## BOSS/特殊多效果（完整说明）

以下为 `data/skills.xml` 中出现的 BOSS 或特殊技能多效果 ID，用于专属精灵（MonID）技能。**参数数量**已在 `internal/game/skills/effects.go` 的 `effectArgCount` 中声明，多效果解析时能正确切分参数；**Handlers** 中多效果循环已为每个 ID 预留分支，当前仅消费参数不写状态，便于后续按配置扩展威力/先制/固伤等逻辑。

### 涉及技能与 MonID

| 技能名 | Move ID | MonID | SideEffect 组合 | SideEffectArg 示例 |
|--------|---------|-------|------------------|--------------------|
| 痴愚 | 13739 | 4661 | 179 700 1083 1257 1248 456 | 220 1 3 100 31 300 |
| 谄诳 | 13740 | 4661 | 179 1603 1083 1257 1248 456 | 270 100 1 3 100 31 300 |
| 红莲 | 13741 | 4661 | 179 1603 180 1257 1248 456 | 320 100 1 3 100 31 300 |
| 皆苦 | 13742 | 4661 | 179 1603 180 1925 1248 456 | 370 100 1 3 100 31 300 |
| 非天 | 13743 | 4661 | 179 1603 180 1925 1605 456 | 420 100 1 3 100 31 300 |
| 五衰 | 13744 | 4661 | 179 1603 180 1925 1605 691 | 470 100 1 3 100 31 100 |
| 简 | 13745 | 4677 | 1470 976 935 773 | 1 28 |
| 极 | 13746 | 4677 | 1470 976 935 773 | 1 28 |
| 希 | 13747 | 4706 | 2236 1850 1211 2237 | 3 1 100 300 100 |

### 效果 ID 与参数说明

| 效果 ID | 参数个数 | 出现技能 | 参数含义（推断） | 实现状态 |
|---------|----------|----------|------------------|----------|
| 691 | 1 | 五衰 | 末尾条件或倍率（如 100） | 占位，多效果循环已消费参数 |
| 700 | 1 | 痴愚 | 威力或类型（1） | 占位，多效果循环已消费参数 |
| 773 | 0 | 简、极 | 无独立参数，与 1470/976/935 共用 2 参 | 占位 |
| 935 | 0 | 简、极 | 无独立参数 | 占位 |
| 976 | 1 | 简、极 | 第二参（28），可能为固定伤害或倍率 | 占位，多效果循环已消费参数 |
| 1083 | 1 | 痴愚、谄诳等 | 回合或阈值（3） | 占位，多效果循环已消费参数 |
| 1211 | 2 | 希 | 双参（100 300），可能为伤害阈值或倍率 | 占位，多效果循环已消费参数 |
| 1248 | 1 | 痴愚系列 | 条件或回合（31） | 占位，多效果循环已消费参数 |
| 1257 | 1 | 痴愚系列 | 条件或回合（100） | 占位，多效果循环已消费参数 |
| 1470 | 1 | 简、极 | 首参（1），可能为类型或回合 | 占位，多效果循环已消费参数 |
| 1603 | 2 | 谄诳、红莲、皆苦、非天、五衰 | 两参（如 100 1），首参常为百分比威力或条件 | 占位，多效果循环已消费参数 |
| 1605 | 1 | 非天、五衰 | 条件参（31） | 占位，多效果循环已消费参数 |
| 1850 | 1 | 希 | 条件参（1） | 占位，多效果循环已消费参数 |
| 1925 | 1 | 皆苦、非天、五衰 | 条件参（3） | 占位，多效果循环已消费参数 |
| 2236 | 1 | 希 | 扩展效果（3） | 占位，多效果循环已消费参数 |
| 2237 | 1 | 希 | 末尾参（100） | 占位，多效果循环已消费参数 |

同链中的 **179**（属性相同威力）、**180**（时空漩涡类）、**456**（先制或伤害相关）等已在 Handlers/ApplyEffect 中另有实现或占位，多效果解析时与上表 ID 一起按顺序消费参数。

## 多效果技能

技能 `SideEffect="43 508"`、`"48 545"` 等会按 `ParseSideEffectIds` 与 `EffectArgCount` 切分参数，依次应用。Handlers 中多效果循环会设置：58, 508, 81, 91, 1635, 439, 448, 478, 545, 87, 89, 90, 92, 98, 104, 106, 108, 109。

## 更新说明

- **effectArgCount 与 applyOneEffect 补全**：20/22（疲惫类 2 参）、33（消除对手能力提升，0 参）、41~56（44 特防减半、45 防御同对手、46 挡 n 次、47 免疫能力下降、48 免疫异常、49 吸收、50 物防减半、51 攻击同对手、52 先手 miss、55 属性反转、56 属性相同，均 1 参）、62/68/69/73（各 1 参）、71/72（0 参）、401/468（0 参，多效果链/能力下降威力翻倍）已在 effectArgCount 中声明；44~56、62、68、69、71、72、73 在 applyOneEffect 中为占位（逻辑由 handlers 多效果/主 switch 处理）。
- 66/67：玩家击杀敌方时触发回血与减对方下只最大 HP。
- 87：多效果中恢复己方全部技能 PP。
- 3：无参数或首参为 0 时解除己方能力下降，有参数时同 4 提升能力。
- 所有在 XML 中出现的 BOSS/高编号效果 ID 均已显式 case，避免静默走 default。
- 119：奇偶伤害分支效果（疲惫/速度+1）已实现。
- 147/148/158/172/173/186：先后手/击败条件效果已在 ApplyEffect 中实现基础逻辑，handlers 负责先后手/击败过滤。
- 188：对手异常时威力翻倍（handlers）并消除对手防/特防强化（ApplyEffect）。
- 195：无视对手双防提升，直接清零对手防御/特防正向 battleLv。
- 201：组队回血效果（单人战斗时同样生效）。
- 402/405/428：先后手/天敌附加固定伤害，handlers 负责条件过滤，ApplyEffect 负责扣血。
- effectArgCount 新增 118(0)、195(0)、201(1) 的参数数量声明。
- 127/144/146/149/150：127 伤害减半（掷骰设回合+受击减半）；144 牺牲全血+下一只免疫异常（ApplyEffect 归零 HP，换宠两处赋免疫）；146 受物理攻击时概率使对方中毒；149 命中后双异常独立判定（4 参）；150 对手每回合防/特防等级 m（回合末设定并递减）。敌方 127/146/150 对称逻辑已接好。
- 91：n 回合内双方状态变化同时影响己方与对手。BattleState 新增 PlayerStatusMirrorRounds/EnemyStatusMirrorRounds；使用技能时设回合；ApplyEffect 后若镜像回合>0 则按双方能力等级与异常状态变化 delta 同步到对方（双 delta 叠加），敌方 91 对称+回合末递减。
- 已实现表补全：112/114/115/116/117/120/124、61/70/88、429/471/484/490；占位改为「占位与说明」，标明多数已在 Handlers/ApplyEffect 实现。
- BOSS/特殊多效果：为 691/700/773/935/976/1083/1211/1248/1257/1470/1603/1605/1850/1925/2236/2237 在 effectArgCount 中声明参数数量（773/935 为 0，与简/极 SideEffectArg="1 28" 对齐），新增「BOSS/特殊多效果」表与说明。
- BOSS/特殊多效果完整完善：文档改为大陆中文说明，补充「涉及技能与 MonID」「效果 ID 与参数说明」两表（含技能名、Move ID、MonID、SideEffect 组合、参数含义与实现状态）；Handlers 多效果循环中为上述 BOSS 效果 ID 增加显式 case（当前仅消费参数、占位），effects.go 注释改为简体。
