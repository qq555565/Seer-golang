# 右边其他玩家视角看不见左边超能 NONO 飞行形态 — 排查与兜底

## 一、必做的三处 Flash 修改（缺一不可）

右边视角要正确显示左边玩家的**超能 NONO 飞行形态**，以下三处必须都做且**右边客户端加载的是改过的 SWF**：

| 序号 | 位置 | 作用 |
|------|------|------|
| 1 | **NonoManager** | 2112 常驻监听，右边才能处理服务端广播的 2112，触发他人 FLY_MODE |
| 2 | **UserListCmdListener** | 2003 里对每条他人若 actionType≠0 补发 FLY_MODE，进图/刷新时他人立刻显示飞行 |
| 3 | **BasePeoleModel** | showNono 他人飞行用 NonoFlyModel；FLY_MODE 分支里补 dispatch WALK_START，并能为他人拼 NonoInfo 调 showNono |

参考：`NonoManager_改后全文.txt`、`UserListCmdListener_改后全文.txt`、`BasePeoleModel_改好完整版.txt`。

---

## 二、右边必须用同一套改过的 SWF

- 若左边、右边是**两个浏览器/两个客户端**，**右边**也必须加载**已修改的 NieoCore（或含上述逻辑的 SWF）**。
- 若只改了左边用的 SWF，右边仍是原版，则右边不会监听 2112、不会在 2003 补发 FLY_MODE，也不会用 NonoFlyModel 显示他人飞行。
- 建议：两个窗口都从**同一地址**加载游戏，并**清缓存或强刷**，确保都拉到最新 SWF。

---

## 三、确保 UserInfo 从 2003 里解析出 superNono

他人 FLY_MODE 时，BasePeoleModel 用 `this._info.superNono` 和 `this._info.nonoColor` 拼 NonoInfo。若 **UserInfo.setForPeoleInfo** 没有从 2003 的 NoNo 段读出 SuperNono，则 `superNono` 为 0，不会拼 _loc4_，也不会调 showNono。

- 2003 的 NoNo 段顺序（与服务端一致）：**Flag(4), State(4), Color(4), SuperNono(4), transTime(4)**。
- 在 **UserInfo.setForPeoleInfo** 里，读完 Flag、State、nonoColor 后，再读一个 uint 作为形态，并赋给 **param1.superNono**（并限制在 1–5）。
- 参考：`UserInfo_改后全文.txt` 中 setForPeoleInfo 的 NoNo 段（约 230–251 行）。

---

## 四、兜底：他人飞行时 superNono 为 0 也显示飞行（形态 1）

若因历史版本或解析差异导致他人 `this._info.superNono` 为 0，当前逻辑不会拼 NonoInfo，他人就不会显示飞行。可在 **BasePeoleModel** 的 FLY_MODE 分支里为他人增加兜底：**当 actionType != 0 且尚无 _loc4_ 时，用 superStage=1 拼一个 NonoInfo**，这样至少能显示飞行（形态 1），避免完全不显示。

在 `case PeopleActionEvent.FLY_MODE:` 里，把原来的：

```actionscript
else
{
   _loc4_ = this._info.nonoInfo;
   if(!_loc4_ && this._info.superNono != 0)
   {
      _loc4_ = new NonoInfo();
      _loc4_.userID = this._info.userID;
      _loc4_.superStage = this._info.superNono >= 1 && this._info.superNono <= 5 ? this._info.superNono : 1;
      _loc4_.state = [false,true];
      _loc4_.color = this._info.nonoColor;
   }
}
```

改为（兜底）：

```actionscript
else
{
   _loc4_ = this._info.nonoInfo;
   if(!_loc4_ && this._info.actionType != 0)
   {
      _loc4_ = new NonoInfo();
      _loc4_.userID = this._info.userID;
      _loc4_.superStage = this._info.superNono >= 1 && this._info.superNono <= 5 ? this._info.superNono : 1;
      _loc4_.state = [false,true];
      _loc4_.color = this._info.nonoColor;
   }
}
```

即条件从 `this._info.superNono != 0` 改为 **`this._info.actionType != 0`**：只要他人是飞行状态就尝试拼 NonoInfo；形态优先用 superNono，没有则用 1。

---

## 五、服务端已具备的条件

- 2003 已带每人 **actionType**（飞行 4）和 **SuperNono**（形态 1–5），与 UserInfo.setForPeoleInfo 顺序一致。
- 2112 已向同图广播；9019 body 已按 FollowCmdListener 顺序（含 superStage）对齐。

若右边仍看不见，请按上面 1～4 逐项确认，并确保右边使用的是同一套改过的 SWF。
