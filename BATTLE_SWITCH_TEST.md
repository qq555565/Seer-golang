# 对战切换精灵功能测试指南

## 修复内容
已修复对战中精灵HP为0时无法切换精灵的问题。

## 问题原因
后端在发送2505命令（USE_SKILL响应）时，第一个AttackValue中的`remainHP`字段使用的是敌人反击后的玩家HP，导致前端HP更新逻辑混乱，无法正确触发切换精灵面板。

## 修复方案
修改了`handleUseSkill`函数中构建2505响应的逻辑：
- 第一个AttackValue现在正确显示玩家攻击后、敌人反击前的HP
- 第二个AttackValue显示敌人反击后的HP
- 这样前端可以正确地分两步更新HP，并在HP为0时触发切换精灵面板

## 测试步骤

### 1. 启动服务器
```bash
cd golang_version
gameserver.exe
```

### 2. 登录游戏
- 打开客户端
- 登录账号
- 进入游戏

### 3. 准备测试环境
- 确保你有至少2只精灵
- 确保第一只精灵的HP不是满的（可以通过对战消耗一些HP）
- 找一个野怪进行对战

### 4. 测试场景A：玩家精灵被击败
1. 进入对战
2. 使用技能攻击敌人
3. 让敌人反击将你的精灵HP打到0
4. **预期结果**：前端应该弹出切换精灵面板
5. 选择另一只精灵
6. **预期结果**：成功切换到新精灵，战斗继续

### 5. 测试场景B：玩家击败敌人
1. 进入对战
2. 使用技能将敌人HP打到0
3. **预期结果**：战斗结束，显示胜利画面
4. **预期结果**：不应该弹出切换精灵面板

### 6. 测试场景C：多回合对战
1. 进入对战
2. 进行多个回合的攻击
3. 观察HP变化是否正确
4. 当精灵HP为0时，确认切换精灵面板弹出
5. 切换精灵后继续战斗

## 验证要点

### 前端日志检查
观察浏览器控制台，应该看到：
1. 收到2505命令
2. 处理两个AttackValue
3. HP正确更新
4. 当HP为0时，触发NO_BLOOD事件
5. 弹出切换精灵面板

### 后端日志检查
观察服务器日志，应该看到：
```
[2405] 使用技能前: PlayerHP=X/Y EnemyHP=A/B
[2405] 使用技能后: PlayerHP=X2/Y EnemyHP=A2/B Damage=D1 EnemyDamage=D2
```
- 如果玩家HP为0，应该看到：
```
[2405] 当前精灵被击败，但玩家还有其它精灵可用，等待 2407 切换精灵
```
- 当玩家切换精灵时，应该看到：
```
收到 CMD=2407 UID=100000005 SEQ=X LEN=Y
[2407] 更新战斗状态: PlayerHP=Z/W PetID=P
```

## 常见问题

### Q1: 切换精灵面板没有弹出
**可能原因**：
1. 只有一只精灵（没有其他精灵可切换）
2. 其他精灵HP也为0
3. 前端缓存问题，尝试刷新页面

### Q2: 切换精灵后还是原来的精灵
**可能原因**：
1. 后端2407命令处理有问题
2. 检查后端日志是否收到2407命令
3. 检查是否正确发送了2301命令（精灵信息）

### Q3: HP显示不正确
**可能原因**：
1. 前端缓存问题
2. 2508命令（更新属性）没有正确发送
3. 检查后端日志中的HP值是否正确

## 成功标志
✓ 当精灵HP为0时，自动弹出切换精灵面板
✓ 可以选择其他精灵进行切换
✓ 切换后战斗继续，新精灵正确显示
✓ HP变化正确，没有异常跳变
✓ 战斗结束逻辑正常

## 回滚方法
如果修复导致问题，可以回滚：
```bash
cd golang_version
git checkout internal/handlers/handlers.go
go build -o gameserver.exe ./cmd/gameserver
```

## 相关文件
- `internal/handlers/handlers.go` - 主要修改文件
- `BATTLE_FIX.md` - 详细的修复说明
- `battle_switch_pet.patch` - 补丁文件
- `apply_battle_fix.py` - 自动应用修复的脚本
